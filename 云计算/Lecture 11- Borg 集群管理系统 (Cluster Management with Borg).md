## 1. Borg 简介与动机 (Introduction & Motivation)

### 1.1 什么是 Borg

- Borg 是由 Google 开发的集群管理系统 (cluster management system)
- 可以视为一个数据中心级别的操作系统 (OS of Cluster/Datacenter)
- 用于管理部署在成千上万台机器上的应用程序

### 1.2 设计目标与动机

- **隐藏资源管理细节** (Hide the details)：让开发者专注于应用开发而非资源管理
- **提供资源共享** (Provide resource sharing)：有效利用硬件资源
- **确保高可靠性与高可用性** (Provide high reliability and availability)：对集群系统至关重要
- **管理异构环境** (Manage heterogeneous environments)：处理不同类型、性能、配置的机器

### 1.3 Borg 的价值

- 简化应用开发和部署流程
- 提高数据中心资源利用率
- 降低应用程序故障率
- 支持大规模分布式应用

## 2. Borg 的用户视角 (The User Perspective)

### 2.1 工作负载类型 (Workload Types)

- **生产型工作负载** (Production jobs / prod):
    - 长时间运行的服务 (long-running services)
    - 需要高可用性 ("never" go down)
    - 对延迟敏感 (latency-sensitive)
    - 例如：Gmail、Google Docs、网页搜索等用户面向产品
- **非生产型工作负载** (Non-production jobs / non-prod):
    - 批处理作业 (batch jobs)
    - 执行时间从几秒到几天不等
    - 对短期性能波动不敏感
    - 例如：数据分析、训练机器学习模型等

### 2.2 集群组织 (Cells)

- **Cell (单元)**: ==被 Borg 管理的一个集群==
- 典型规模：中等大小的 cell 包含约 10,000 台机器
- 特点：异构性 (heterogeneous)，包含不同类型、性能的机器

### 2.3 作业与任务 (Jobs and Tasks)

- **Job (作业)**: 用户提交给 Borg 的工作单位
    - 一个作业包含一个或多个运行相同程序的任务
    - 每个作业只在一个 cell 中运行
    - 通过配置文件定义 (如 `hello_world_webserver.borg`)
    - 提交命令: `borgcfg .../hello_world_webserver.borg up`
- **Task (任务)**: 作业中的单个实例
    - 对应一个运行在容器中的 Linux 进程
    - 有自己的资源需求和限制

### 2.4 资源分配与控制 (Allocs, Priority, and Quota)

- **Alloc (分配)**:
    - 在机器上预留的一组资源
    - 资源保持分配状态，无论使用与否
    - 可用于在不同作业中的任务之间共享资源
    - 例如：将 Web 服务器实例与其日志保存程序部署在同一机器上
- **Priority (优先级)**:
    - 表达作业相对重要性
    - 高优先级任务可以抢占低优先级任务资源
    - 不允许生产优先级任务相互抢占
    - 优先级影响调度顺序与抢占决策
- **Quota (配额)**:
    - 表示为特定优先级下资源数量的向量 (CPU、RAM、磁盘等)
    - 指定用户作业一次可请求的最大资源量
    - 配额检查是准入控制的一部分，而非调度
    - 配额不足的作业在提交时立即被拒绝

### 2.5 命名与监控 (Naming and Monitoring)

- 任务命名格式: `<task number>.<job name>.<user name>.<cell name>.borg.google.com`
- 例如: `50.jfoo.ubar.cc.borg.google.com`
- 监控功能:
    - 监控任务的健康状态
    - 跟踪数千个性能指标
    - 支持故障诊断与性能优化

## 3. Borg 架构与组件 (Borg Architecture and Components)

### 3.1 Borg 架构概述

- Borg 集群包含成千上万台机器，通过数据中心级网络互联
- 主要组件:
    - **BorgMaster**: 逻辑上集中的控制器
    - **Borglets**: 运行在 cell 中每台机器上的代理程序
        
        ![[截屏2025-05-10_18.53.50.png]]
        

### 3.2 BorgMaster 详解

- **高可用性设计**:
    - BorgMaster 采用 5 个副本进行复制
    - 每个副本在内存中维护 cell 状态的副本
    - 使用基于 Paxos 的存储在每个副本的本地磁盘上记录 cell 状态
    - 选举出的主副本作为 Paxos 领导者，处理改变 cell 状态的操作
- **主要功能**:
    1. 处理客户端 RPC 请求 (状态更改或数据查询)
    2. 管理机器、任务、分配等系统对象的状态机
    3. 与 Borglets 通信
    4. 响应 Web 界面的请求
- **状态持久化**:
    - 可将状态保存为检查点文件 (==checkpoint== file)
    - 检查点可用于性能研究或恢复早期状态
    - 模拟器 (FauxMaster) 可重放检查点以改进系统

### 3.3 Borglet 详解

- 运行在 cell 中每台机器上的代理程序
- 主要功能:
    - 启动、停止、重启失败的任务
    - 管理本地资源 (通过操作系统内核设置)
    - 向 BorgMaster 报告本地状态
    - 执行 BorgMaster 下达的命令

### 3.4 任务状态变化

任务状态可通过用户请求和系统操作改变:

- **用户操作**:
    - submit (提交)
    - kill (杀死)
    - update (更新)
- **系统操作**:
    - reject (拒绝)
    - evict (驱逐)
    - lose (丢失)
    - fail (失败)
- **主要状态**:
    - Pending (待处理)
    - Running (运行中)
    - Dead (已终止)

![[截屏2025-05-10_18.56.04.png]]

## 4. Borg 调度系统 (Borg Scheduler)

### 4.1 调度器基本工作流程

- 调度器周期性地以轮询方式扫描待处理任务的优先级队列
- 从高优先级到低优先级处理，同一优先级内采用轮询方式确保公平性
- 调度过程包含两个主要步骤:
    1. **可行性检查** (Feasibility checking): 找到满足任务约束且有足够可用资源的机器集合
    2. **评分** (Scoring): 确定每台可行机器的"好坏"程度以选择最佳部署位置

### 4.2 资源分配与使用

- 生产作业分配约 70% 的 CPU 资源和 55% 的内存资源
- 大多数作业不在虚拟机内运行，任务映射到在容器中运行的 Linux 进程
- 在 Google 的一个 12,000 服务器集群中的资源利用情况:
    - 整体 CPU 利用率: 25-35%
    - 整体内存利用率: 40%
    - 使用预留系统后，这些数字分别提高到 75% 和 60%

### 4.3 优先级与配额系统

- 定义了不同的优先级级别 (bands)，用于监控、生产、批处理和测试等活动
- 配额系统使用资源向量 (CPU、RAM、磁盘等) 进行作业调度
- 高优先级配额的成本高于低优先级配额
- 调度器启动多个并发进程来管理大型 cell，这些进程使用 cell 状态的缓存副本

### 4.4 性能优化

- 为避免为每个待处理任务评估每台机器的可行性，Borg 按照任务等价类 (equivalence classes) 计算可行性和评分
- 等价类是具有相似需求的任务组
- 评估不针对 cell 中的每台机器进行，而是针对随机机器进行，直到找到足够的合适机器

## 5. 资源回收与利用 (Resource Reclamation)

### 5.1 资源回收机制

- **资源限制** (Resource limit):
    - 作业可以指定每个任务应被授予的资源上限
    - 用于准入控制和任务调度
- **资源回收** (Resource reclamation):
    - 回收已分配但未被消耗的资源用于可以容忍低质量资源的工作 (如批处理作业)
    - BorgMaster 每隔几秒计算一次任务的预留 (reservation)，基于 Borglet 捕获的细粒度使用情况

### 5.2 资源回收效果

- 在中位数 cell 中，约 20% 的工作负载运行在回收的资源上
- 大多数任务使用的资源远低于其限制
- 资源估计成功识别未使用的资源，使预留值更接近 100%
- 如果禁用资源回收，将需要额外 20-30% 的机器

### 5.3 资源利用与优化

- 添加任务到机器上会增加其他任务的 CPI (Cycles Per Instruction) 约 0.3%
- 增加机器 CPU 使用率 10% 会使 CPI 增加不到 2%
- CPU 减速的影响小于通过资源共享减少所需机器数量带来的好处
- 共享优势适用于所有资源 (内存、磁盘等)，而不仅仅是 CPU

## 6. 负载均衡策略 (Load Balancing Strategies)

### 6.1 E-PVM 与负载分散

- Borg 最初使用 E-PVM (Enhanced Per-Virtual-Machine) 变体进行评分
- E-PVM 生成跨异构资源的单一成本值，最小化放置任务时的成本变化
- 实际中，==E-PVM 将负载分散到所有机器上，为负载峰值留出空间==
- 缺点：增加资源碎片化，尤其对需要大部分机器资源的大型任务

### 6.2 紧凑填充策略

- 与分散策略相反，尝试尽可能紧密地填充机器
- 优点：使一些机器没有用户作业 (仍运行存储服务器)，便于放置大型任务
- 缺点：紧密打包会放大用户或 Borg 对资源需求的错误估计

### 6.3 混合评分模型

- 当前 Borg 使用混合评分模型，结合上述两种策略的优点
- 在资源利用率和灵活性之间取得平衡
- 适应不同规模任务的需求

## 7. 资源超卖与配额管理 (Resource Overselling and Quota Management)

### 7.1 配额超卖 (Over-selling quota)

- 生产优先级配额限制在 cell 中实际可用的资源范围内
- 许多用户购买过多配额，以防未来应用用户基数增长时资源短缺
- 低优先级作业可能被接受但因资源不足而保持待处理状态 (未调度)

### 7.2 请求与实际使用的差距

- 问题：如果请求的资源远大于实际消耗的资源?
- 这会导致资源浪费和利用率低下
- Borg 通过资源回收机制解决这个问题，重新分配未使用的资源

### 7.3 容器与资源控制

- Borg 使用 Linux cgroups (控制组) 限制和隔离资源使用
- cgroups 跟踪和限制进程组的内存和 CPU 使用
- 资源使用超出限制的后果:
    - 使用过多内存: 进程被 OOM (Out of Memory) 终止
    - 使用过多 CPU: 进程被减速

## 8. 上下文切换与性能影响 (Context Switching and Performance Impact)

### 8.1 CPU 上下文切换基础

![[截屏2025-05-10_19.11.06.png]]

- 上下文切换: 将一个进程的状态保存到其 PCB (Process Control Block)，然后加载另一个进程的状态
- 切换过程:
    1. 保存当前进程状态
    2. 选择下一个要运行的进程
    3. 加载被选进程的状态
    4. 将 CPU 控制权转交给该进程

### 8.2 任务调度与性能

- 上下文切换会导致额外开销，包括:
    - CPU 时间用于保存和恢复上下文
    - 缓存污染 (cache pollution)
    - TLB (Translation Lookaside Buffer) 刷新
- 但 Borg 的研究显示，合理的共享和调度可以使这些开销最小化
- CPU 减速的影响小于通过资源共享减少所需机器数量带来的好处

## 总结 (Summary)

Borg 是 Google 开发的大规模集群管理系统，用于管理跨数千台机器的应用程序。它支持两种主要工作负载：长期运行的生产服务和批处理作业。Borg 通过 BorgMaster 和 Borglets 组件管理集群资源，采用优先级和配额系统进行调度决策。其创新包括资源回收机制、混合评分模型和高效的上下文切换管理，这些都显著提高了资源利用率。Borg 通过隐藏资源管理细节，让开发者专注于应用开发，同时提供高可靠性和可用性，代表了现代大规模分布式系统管理的典范。

### 关键术语表

- **Borg**: Google 的集群管理系统
- **Cell**: 被 Borg 管理的一个集群
- **BorgMaster**: Borg 的中央控制器
- **Borglet**: 运行在每台机器上的代理程序
- **Job**: 包含一个或多个任务的工作单位
- **Task**: 在容器中运行的单个进程
- **Alloc**: 在机器上预留的一组资源
- **Priority**: 作业的相对重要性
- **Quota**: 用户可以请求的资源限制
- **Resource Reclamation**: 回收已分配但未使用的资源
- **E-PVM**: Borg 最初使用的评分算法
- **Production Jobs**: 长期运行的服务型工作负载
- **Non-production Jobs**: 批处理型工作负载